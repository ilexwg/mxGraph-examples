<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>04-anchor</title>
  <style>
    * {
      padding: 0;
      margin: 0;
    }

    #container {
      width: 100vw;
      height: 100vh;
      background: url(./images/grid.gif);
    }
  </style>
</head>

<body>
  <div id="container"></div>

  <script>
    mxBasePath = '../mxgraph';
  </script>
  <script src="../mxgraph/mxClient.js"></script>
  <script>
    function main(container) {
      // 禁用鼠标右键菜单
      mxEvent.disableContextMenu(container);

      const graph = new mxGraph(container);

      // 设置节点之间可以连接
      graph.setConnectable(true);

      graph.setAllowDanglingEdges(false);

      // 开启区域选择
      new mxRubberband(graph);

      // 定义靶点
      mxShape.prototype.constraints = [
        new mxConnectionConstraint(new mxPoint(0.25, 0), true),
        new mxConnectionConstraint(new mxPoint(0.5, 0), true),
        new mxConnectionConstraint(new mxPoint(0.75, 0), true),
        new mxConnectionConstraint(new mxPoint(0, 0.25), true),
        new mxConnectionConstraint(new mxPoint(0, 0.5), true),
        new mxConnectionConstraint(new mxPoint(0, 0.75), true),
        new mxConnectionConstraint(new mxPoint(1, 0.25), true),
        new mxConnectionConstraint(new mxPoint(1, 0.5), true),
        new mxConnectionConstraint(new mxPoint(1, 0.75), true),
        new mxConnectionConstraint(new mxPoint(0.25, 1), true),
        new mxConnectionConstraint(new mxPoint(0.5, 1), true),
        new mxConnectionConstraint(new mxPoint(0.75, 1), true)
      ];

      // 重写以定义每个形状的连接点
      mxGraph.prototype.getAllConnectionConstraints = function(terminal, source) {
        if (terminal != null && terminal.shape != null) {
          if (terminal.shape.stencil != null) {
            return terminal.shape.stencil.constraints;
          } else if (terminal.shape.constraints != null) {
            return terminal.shape.constraints;
          }
        }

        return null;
      };

      // 绘制节点
      const parent = graph.getDefaultParent();
      graph.getModel().beginUpdate();
      try {
        const foo = graph.insertVertex(parent, null, 'foo', 100, 100, 100, 100);
        const bar = graph.insertVertex(parent, null, 'bar', 300, 300, 100, 100);
      } finally {
        graph.getModel().endUpdate();
      }

      // 连接节点事件
      graph.addListener(mxEvent.CELL_CONNECTED, () => {
        console.log('cell connected');
      });

      // 添加cell事件
      graph.addListener(mxEvent.ADD_CELLS, () => {
        setTimeout(() => {
          console.log('add cells');
        }, 0);
      });
    }

    window.onload = function () {
      const container = document.getElementById('container');

      main(container);
    };
  </script>
</body>

</html>